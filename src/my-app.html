<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth-script.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="components/my-header.html">
<link rel="import" href="components/my-invite.html">
<link rel="import" href="components/my-login.html">
<link rel="import" href="my-redux.html">


<dom-module id="my-app">
  <template>
    <style >
      :host {
        display: block;
      }

    </style>

    <firebase-app 
        name="bkawkfirebase" 
        api-key="AIzaSyAhoCXxkY-ffNwA_7L7HIwBVpASYj1btNE" 
        auth-domain="convoo-login-demo.firebaseapp.com" 
        database-url="https://convoo-login-demo.firebaseio.com"
        storage-bucket="the-app-4e238.appspot.com"
        messaging-sender-id="916383740318">
    </firebase-app>
    <firebase-auth app-name="bkawkfirebase" id="authid" user="{{user}}" provider="{{provider}}" on-error="handleError"></firebase-auth>

    <iron-media-query query="max-width: 415px" query-matches="{{mobile}}"></iron-media-query>  

    <template is="dom-if" if="{{showInvite}}"><my-invite></my-invite></template>
    <template is="dom-if" if="{{showLogin}}"><my-login></my-login></template>

    <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

    <app-drawer-layout force-narrow>
      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer" swipe-open opened="{{drawer}}">
      </app-drawer>

      <!-- Main content -->
      <app-header-layout>
        <app-header slot="header" condenses fixed effects="waterfall" id="appHeader">
            <my-header></my-header>
        </app-header>

        <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="view404" role="main">
          <my-view1 name="view1"></my-view1>
          <my-view2 name="view2"></my-view2>
          <my-view3 name="view3"></my-view3>
          <my-view404 name="view404"></my-view404>
        </iron-pages>

      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    class MyApp extends ReduxMixin(Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element)) {

      static get is() { 
        return 'my-app'; 
      }
      static get actions() {
        return Object.assign({
          USER: function(user){
              return { type: 'USER', user: user}
          },
          MOBILE: function(mobile){
              return { type: 'MOBILE', mobile: mobile}
          },
          DRAWER: function(drawer){
                return { type: 'DRAWER', drawer: drawer}
          }
      });
    }
      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          },
          mobile: {
            type: Boolean,
            observer: '_mobile',
          },
          loggedIn: {
            type: Boolean,
            statePath: 'loggedIn',
          },
          drawer: {
            type: Boolean,
            statePath: 'drawer',
            observer: '_drawer',
          },
          showInvite: {
            type: Boolean,
            statePath: 'showInvite',
          },
          showLogin: {
            type: Boolean,
            statePath: 'showLogin',
          },
          provider: {
            type: String,
            value: 'google',
            statePath: 'provider',
            observer: '_provider',
          }
        };
      }
      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
        ];
      }
      connectedCallback(){
          super.connectedCallback();
          this.loadResources(this.resolveUrl("./my-locales.json"));
      }
      _provider(){
        if(this.provider == 'facebook' || this.provider == 'twitter'){
          this.$.authid.signInWithPopup().then(function(response) {
            console.log(response)
          })
          .catch(function(error) {
            console.log(error)
          });
        }
      }
      _drawer(){
            this.dispatch('DRAWER', this.drawer);
      }
      _mobile(){
        this.dispatch('MOBILE', this.mobile);
        if(!this.mobile){
          this.drawer = false
        }
        const header = this.$.appHeader;
        if(this.mobile){
            header.fixed = false;
        } else {
            header.fixed = true;
        }
      }
      _routePageChanged(page){
        if (page === undefined) {
          return;
        }
        this.page = page || 'view1';
        this.drawer = false
      }
      _pageChanged(page){
        const resolvedPageUrl = this.resolveUrl('my-' + page + '.html');
        Polymer.importHref(
            resolvedPageUrl,
            null,
            this._showPage404.bind(this),
            true);
      }
      _showPage404(){
        this.page = 'view404';
      }
    }

    window.customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>
